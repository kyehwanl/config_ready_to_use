
Docker Ready To Use
=====================

-----------------------
1. Making  Dockerfile 
------------------------

<Dockerfile-ready-to-use>/*{{{*/

FROM ubuntu:24.04

# --- from .env or host export argument ---
ARG USER_ID=1000
ARG GROUP_ID=1000
ARG USER_NAME=dev

# --- Basic Package Install ---
RUN apt-get update && apt-get install -y \
    sudo build-essential git curl vim wget \
 && rm -rf /var/lib/apt/lists/*

# --- ê·¸ë£¹/ìœ ì € ìƒì„± ---
#   - í•´ë‹¹ GID/UIDê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ë§Œë“¤ê³ 
#   - ì´ë¯¸ ìˆìœ¼ë©´ useradd/groupaddê°€ ì‹¤íŒ¨í•˜ë‹ˆ, ê·¸ëŸ° ê²½ìš°ì—” ê¸°ì¡´ ê³„ì • ì´ë¦„ë§Œ USER_NAMEìœ¼ë¡œ ë°”ê¾¸ëŠ” ì‹ìœ¼ë¡œ ì²˜ë¦¬
RUN set -eux; \
    if getent group "${GROUP_ID}" >/dev/null; then \
        # ê°™ì€ GIDê°€ ì´ë¯¸ ìˆìœ¼ë©´ ì´ë¦„ë§Œ USER_NAMEìœ¼ë¡œ ë°”ê¿ˆ
        groupmod -n "${USER_NAME}" "$(getent group "${GROUP_ID}" | cut -d: -f1)"; \
    else \
        groupadd -g "${GROUP_ID}" "${USER_NAME}"; \
    fi; \
    if getent passwd "${USER_ID}" >/dev/null; then \
        # ê°™ì€ UIDê°€ ì´ë¯¸ ìˆìœ¼ë©´ ì´ë¦„ë§Œ USER_NAMEìœ¼ë¡œ ë°”ê¿ˆ
        usermod -l "${USER_NAME}" -d "/home/${USER_NAME}" -m \
            "$(getent passwd "${USER_ID}" | cut -d: -f1)"; \
        usermod -g "${GROUP_ID}" "${USER_NAME}"; \
    else \
        useradd -m -u "${USER_ID}" -g "${GROUP_ID}" "${USER_NAME}"; \
    fi

# --- sudo ê¶Œí•œ ë¶€ì—¬ ---
RUN echo "${USER_NAME} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# --- ê¸°ë³¸ ìœ ì €/ì‘ì—… ë””ë ‰í„°ë¦¬ ---
USER ${USER_NAME}
WORKDIR /workspace

# --- READY-TO-USE Package Install ---
RUN wget https://raw.githubusercontent.com/kyehwanl/config_ready_to_use/refs/heads/master/install-config-ready.sh
RUN chmod +x ./install-config-ready.sh && ./install-config-ready.sh
RUN echo "export SHELL=/bin/bash" >> ~/.bashrc/*}}}*/


(A) Test í…ŒìŠ¤íŠ¸: ì‹¤ì œ í˜¸ìŠ¤íŠ¸ ì‚¬ìš©ì UID/GIDë¡œ ìƒì„±

  export USER_ID=$(id -u)
  export GROUP_ID=$(id -g)
  export USER_NAME=$USER

  docker build \
    -t dtest2 \
    -f Dockerfile-test \
    --build-arg USER_ID=$USER_ID \
    --build-arg GROUP_ID=$GROUP_ID \
    --build-arg USER_NAME=$USER_NAME \
    .


  ì»¨í…Œì´ë„ˆ ì‹¤í–‰:
  docker run --rm -it dtest2 id


  ì¶œë ¥:
  uid=40021(kyehwanl) gid=40021(kyehwanl)


  (ë„ˆì˜ ì„œë²„ UID/GIDì— ë”°ë¼ ë‹¤ë¦„)

  ë˜ í…ŒìŠ¤íŠ¸:
  docker run --rm -it dtest2 bash -lc "sudo whoami"

  â†’ ì¶œë ¥: root



(B) í…ŒìŠ¤íŠ¸ 3: UID/GID ì¶©ëŒ ì¼€ì´ìŠ¤

  Ubuntu ì´ë¯¸ì§€ëŠ” UID 1000 â€œubuntuâ€ ë¥¼ ì´ë¯¸ ê°€ì§€ê³  ìˆìœ¼ë¯€ë¡œ
  ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ í…ŒìŠ¤íŠ¸:

  docker build \
    -t dtest3 \
    -f Dockerfile-test \
    --build-arg USER_ID=1000 \
    --build-arg GROUP_ID=1000 \
    --build-arg USER_NAME=myuser \
    .


  ì»¨í…Œì´ë„ˆ ì‹¤í–‰:
  docker run --rm -it dtest3 id


  â†’ ê¸°ëŒ€ ì¶œë ¥:
  uid=1000(myuser) gid=1000(myuser)

  ì¦‰ ê¸°ì¡´ ubuntu ìœ ì €ê°€ myuser ë¡œ renameë¨.



(C) í…ŒìŠ¤íŠ¸ 4: ì™„ì „ ìƒˆë¡œìš´ UID í…ŒìŠ¤íŠ¸

  docker build \
    -t dtest4 \
    -f Dockerfile-test \
    --build-arg USER_ID=40021 \
    --build-arg GROUP_ID=40021 \
    --build-arg USER_NAME=testuser \
    .


  ì»¨í…Œì´ë„ˆ:
  docker run --rm -it dtest4 id


  â†’ 
  uid=40021(testuser) gid=40021(testuser)





(D) One-linerë¡œ ë§Œë“¤ê¸° (without using compose)

export USER_ID=$(id -u)
export GROUP_ID=$(id -g)
export USER_NAME=$USER

docker volume create gocache

docker build \
  -t dev-ubuntu-rtu \
  -f Dockerfile-ready-to-use \
  --build-arg USER_ID=$USER_ID \
  --build-arg GROUP_ID=$GROUP_ID \
  --build-arg USER_NAME=$USER_NAME \
  .

docker run --rm -it \
  --user $USER_ID:$GROUP_ID \
  -e USER=$USER_NAME \
  -e LANG=C.UTF-8 \
  -e LC_ALL=C.UTF-8 \
  -e GOPATH=/home/$USER_NAME/go \
  -v "$(pwd)":/workspace \
  -v gocache:/home/$USER_NAME/go/pkg/mod \
  -w /workspace \
  dev-ubuntu-rtu \
  bash


< ì„¤ëª…>
--user $USER_ID:$GROUP_ID
â†’ í˜¸ìŠ¤íŠ¸ì™€ ê¶Œí•œ 1:1 ë§¤ì¹­

-e USER=$USER_NAME
â†’ í”„ë¡¬í”„íŠ¸ ì •ìƒ, "I have no name!" ë°©ì§€

-e LANG / -e LC_ALL
â†’ locale ê²½ê³  ë°©ì§€

-e GOPATH
â†’ Go build í™˜ê²½ ìœ ì§€

-v "$(pwd)":/workspace
â†’ í˜„ì¬ ë¡œì»¬ ë””ë ‰í„°ë¦¬ë¥¼ ì»¨í…Œì´ë„ˆ /workspace ì— bind mount

-v gocache:/home/$USER_NAME/go/pkg/mod
â†’ Go module cache volume

-w /workspace
â†’ ê¸°ë³¸ working directory

bash
â†’ ë°”ë¡œ bash ì…¸ ì‹¤í–‰


< ìµœì¢… One-liner (ì™„ì „ì²´) >
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

volume ë§Œë“¤ê¸° + build + run ì„ ëª¨ë‘ í•œ ë²ˆì— í•˜ê¸°:

export USER_ID=$(id -u); \
export GROUP_ID=$(id -g); \
export USER_NAME=$USER; \
docker volume create gocache; \
docker build -t dev-ubuntu-rtu -f Dockerfile-ready-to-use \
  --build-arg USER_ID=$USER_ID \
  --build-arg GROUP_ID=$GROUP_ID \
  --build-arg USER_NAME=$USER_NAME .; \
docker run --rm -it \
  --user $USER_ID:$GROUP_ID \
  -e USER=$USER_NAME \
  -e LANG=C.UTF-8 \
  -e LC_ALL=C.UTF-8 \
  -e GOPATH=/home/$USER_NAME/go \
  -v "$(pwd)":/workspace \
  -v gocache:/home/$USER_NAME/go/pkg/mod \
  -w /workspace \
  dev-ubuntu-rtu \
  bash


ğŸ‘‰ ì´ê²ƒë§Œ í„°ë¯¸ë„ì— ë¶™ì—¬ë„£ìœ¼ë©´
compose ì—†ì´ dev-ubuntu ì„œë¹„ìŠ¤ê°€ ë°”ë¡œ ì‹¤í–‰ë¨.







-----------------------------------
2.  Combning with docker compose
-----------------------------------

# docker-compose-ready-to-use.yml /*{{{*/

# docker-compose.yml (Compose v2)
services:
  dev-ubuntu:
    image: dev-ubuntu-rtu        # Image name: Ready To Use 
    build:
      context: .
      dockerfile: Dockerfile-ready-to-use
      args:
        USER_ID: "${USER_ID:-1000}"
        GROUP_ID: "${GROUP_ID:-1000}"
        USER_NAME: "${USER_NAME:-dev}"
    command: bash
    tty: true
    stdin_open: true
    working_dir: /workspace
    user: "${USER_ID:-1000}:${GROUP_ID:-1000}"
    environment:
      USER: "${USER_NAME:-dev}"
      LANG: C.UTF-8
      LC_ALL: C.UTF-8
      GOPATH: "/home/${USER_NAME:-dev}/go"
    volumes:
      - ./:/workspace                                # ë°”ì¸ë“œvolume: ë¡œì»¬ ì†ŒìŠ¤
      - gocache:/home/${USER_NAME:-dev}/go/pkg/mod   # named voluem: Go ëª¨ë“ˆ ìºì‹œ

  dev-golang:
    image: golang:1.23
    command: bash
    tty: true
    stdin_open: true
    working_dir: /workspace
    user: "${USER_ID:-1000}:${GROUP_ID:-1000}"
    environment:
      GOPATH: /go
    volumes:
      - ./:/workspace
      - gocache:/go/pkg/mod

volumes:
  gocache:

/*}}}*/


1. ì‚¬ìš©ë²•

0) Pre-Requite : í™˜ê²½ë³€ìˆ˜ ì„¸íŒ… (ì„œë²„ë§ˆë‹¤ ìë™ìœ¼ë¡œ ë§ì¶”ê¸°)

rm -f .env

cat <<EOF > .env
USER_ID=$(id -u)
GROUP_ID=$(id -g)
USER_NAME=$USER
EOF


1) í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— workplace/ ë””ë ‰í„°ë¦¬ë¥¼ ë§Œë“¤ê³  ì†ŒìŠ¤ë¥¼ ë„£ì–´ë‘”ë‹¤.(Optional)
 --> defaultë¡œ í˜„ì¬ í´ë”(./)ì— volume mountë¨


2) ë¦¬ëˆ…ìŠ¤/WSLì—ì„œ í™˜ê²½ ë³€ìˆ˜ë¡œ UID/GID ì „ë‹¬: --> ì•ˆë˜ì–´ì„œ .envë¥¼ ì“´ë‹¤

  export UID=$(id -u) GID=$(id -g)
  docker compose run --rm dev-ubuntu    # Ubuntu ì…¸
  docker compose run --rm dev-golang    # Go ì…¸

  macOS/Windowsë„ Composeê°€ UID,GIDë¥¼ ì½ê¸´ í•˜ì§€ë§Œ, í¼ë¯¸ì…˜ ì´ìŠˆê°€ ìƒê¸°ë©´ ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ chown -Rë¡œ 1íšŒ ì •ë¦¬í•´ì£¼ë©´ ë¨.

  --> NEED to make ".env", OTHERWISE, docker-compose yaml hardly get env variables


2. í™•ì¸ í¬ì¸íŠ¸

  - í¼ë¯¸ì…˜: ì»¨í…Œì´ë„ˆ ì•ˆì—ì„œ ìƒì„±í•œ /work(ë˜ëŠ” /workspace) íŒŒì¼ì´ í˜¸ìŠ¤íŠ¸ì—ì„œë„ ë‚´ ì‚¬ìš©ì ì†Œìœ ë¡œ ë³´ì¸ë‹¤.
  - ìºì‹œ ì¬ì‚¬ìš©: dev-golangì—ì„œ í•œ ë²ˆ go buildë¡œ ë°›ì€ ëª¨ë“ˆì´ ë‹¤ìŒ ì‹¤í–‰ì—ì„œë„ ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œë˜ì§€ ì•ŠìŒ(ì†ë„ â†‘).
  - ì»¨í…Œì´ë„ˆ ì²­ì†Œ: --rmë¡œ ì¢…ë£Œí•´ë„ gocache ë³¼ë¥¨ê³¼ ë¡œì»¬ mywork/ëŠ” ê·¸ëŒ€ë¡œ





3. ë¹Œë“œ & ì‹¤í–‰ í…ŒìŠ¤íŠ¸
1) ë¹Œë“œ
  docker compose -f docker-compose-ready-to-use.yaml build dev-ubuntu

  ì •ìƒì´ë¼ë©´ ë§ˆì§€ë§‰ì— Successfully built ... / Successfully tagged dev-ubuntu-test ê°€ ë³´ì¸ë‹¤.


2) ì‹¤í–‰
  docker compose -f docker-compose-ready-to-use.yaml run --rm dev-ubuntu 


3)  ì»¨í…Œì´ë„ˆì—ì„œ id í™•ì¸
  docker compose -f docker-compose-ready-to-use.yaml run --rm dev-ubuntu id

  ê¸°ëŒ€ ì¶œë ¥ (ì˜ˆì‹œ):
  uid=40021(kyehwanl) gid=40021(kyehwanl) groups=40021(kyehwanl)

  â†’ í˜¸ìŠ¤íŠ¸ UID/GID ì™€ ê°™ì€ì§€ í™•ì¸.


4) sudo ê¶Œí•œ í™•ì¸
  docker compose -f docker-compose-ready-to-use.yaml run --rm dev-ubuntu bash -lc 'whoami; sudo whoami'

  ê¸°ëŒ€:
  kyehwanl
  root





4. ë¹ ë¥¸ í…ŒìŠ¤íŠ¸- for golang
  # Go ì˜ˆì œ
  docker compose run --rm dev-golang bash -lc \
	'cd /workspace && printf "package main\nfunc main(){println(\"hi\")}\n" > main.go && go build && ./main'

  # í¼ë¯¸ì…˜ í™•ì¸ (í˜¸ìŠ¤íŠ¸ì—ì„œ)
  ls -l mywork


í•„ìš”í•˜ë©´ dev-golangì— ìì£¼ ì“°ëŠ” íˆ´(ì˜ˆ: make, git)ì„ ì„¤ì¹˜í•˜ë„ë¡ entrypointë¥¼ ì¶”ê°€í•´ì¤„ ìˆ˜ë„ ìˆì–´.









5. Compose í”„ë¡œì íŠ¸ ì „ì²´ë¥¼ ê¹¨ë—í•˜ê²Œ ì§€ìš°ëŠ” ë°©ë²• (ì¶”ì²œ)

* ë„¤íŠ¸ì›Œí¬ + ë³¼ë¥¨ + ì¤‘ë‹¨ëœ ì»¨í…Œì´ë„ˆê¹Œì§€ ì „ë¶€ í•œ ë²ˆì— ì§€ìš°ê³  ì‹¶ìœ¼ë©´:

  docker compose -f docker-compose-ready-to-use.yaml down --volumes --rmi all


* ì˜µì…˜ ì˜ë¯¸:

  down â†’ ì»¨í…Œì´ë„ˆ + default network ì‚­ì œ

  --volumes â†’ compose ì— ì˜í•´ ìƒì„±ëœ named volume ì‚­ì œ

  --rmi all â†’ ë¹Œë“œëœ ì´ë¯¸ì§€ ì‚­ì œ (ì˜µì…˜)

  ì´ ëª…ë ¹ì€ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì´ˆê¸°í™”í•  ë•Œ ê°€ì¥ ê¹”ë”í•˜ë‹¤.



* cleanup ìŠ¤í¬ë¦½íŠ¸â€ ë„ ë§Œë“¤ì–´ì¤„ ìˆ˜ ìˆë‹¤
  ì˜ˆ: clean.sh

  #!/bin/bash
  docker compose -f docker-compose-ready-to-use.yaml down --volumes --rmi all
  docker network prune -f
  docker volume prune -f
  docker image prune -f










6. TroubleShoot & ETC

(1) stat .: permission denied

  $ docker compose -f docker-compose-ready-to-use.yaml build dev-ubuntu
  stat .: permission denied

  $ pwd
  /users/kyehwanl/workspace/docker-ready-to-use-test

--> due to ownership
    change the location or directory's ownership with chown







-----------------------
1ï¸âƒ£ entrypoint ì¤„ì˜ ì˜ë¯¸
-----------------------
entrypoint: ["/bin/bash","-lc","apt-get update && apt-get install -y build-essential vim && exec bash"]


ì´ê±´ ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë  ë•Œ ìë™ìœ¼ë¡œ ì‹¤í–‰í•  ëª…ë ¹ì„ ë®ì–´ì“°ê¸° í•œ ê²ë‹ˆë‹¤.
í•˜ë‚˜ì”© í•´ì„í•˜ë©´ ğŸ‘‡


ë¶€ë¶„		ì˜ë¯¸
/bin/bash	bash ì…¸ë¡œ ëª…ë ¹ì„ ì‹¤í–‰í•˜ê² ë‹¤.
-l			â€œlogin shellâ€ ì˜µì…˜ â€” .bash_profile, .profile ë“±ì„ ì½ì–´ì„œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¸íŒ…í•¨.
-c			ë’¤ë”°ë¥´ëŠ” ë¬¸ìì—´ì„ ëª…ë ¹(command) ìœ¼ë¡œ ì‹¤í–‰í•˜ë¼ëŠ” ì˜ë¯¸.
apt-get update && apt-get install -y build-essential vim	ì»¨í…Œì´ë„ˆê°€ ëœ° ë•Œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ë° í•„ìˆ˜ íˆ´ ì„¤ì¹˜.
exec bash	ì„¤ì¹˜ ëë‚˜ë©´ bash ì…¸ì„ í˜„ì¬ í”„ë¡œì„¸ìŠ¤ë¡œ êµì²´(exec) í•´ì„œ ì¢…ë£Œë˜ì§€ ì•Šê³  ì¸í„°ë™í‹°ë¸Œ ì…¸ ìœ ì§€.




---------------------------------
2ï¸âƒ£ exec bash ì™€ ê·¸ëƒ¥ bash ì˜ ì°¨ì´
---------------------------------
ëª…ë ¹		ë™ì‘
bash		ìƒˆ í”„ë¡œì„¸ìŠ¤ë¥¼ fork í•´ì„œ ì‹¤í–‰. ì›ë˜ í”„ë¡œì„¸ìŠ¤(ì—¬ê¸°ì„œëŠ” bash -lc)ëŠ” ë°±ê·¸ë¼ìš´ë“œì— ë‚¨ì•„ìˆìŒ.
exec bash	í˜„ì¬ í”„ë¡œì„¸ìŠ¤ê°€ bashë¡œ êµì²´ë¨ (PID ë™ì¼). ì›ë˜ í”„ë¡œì„¸ìŠ¤ëŠ” ì™„ì „íˆ ì‚¬ë¼ì§.

ğŸ‘‰ ì¦‰, exec bash ë¥¼ ì“°ë©´ ì»¨í…Œì´ë„ˆ PID 1 í”„ë¡œì„¸ìŠ¤ê°€ ìƒˆ bashë¡œ ë°”ë€Œë¯€ë¡œ
â€œëª…ë ¹ ë‹¤ ëë‚¬ëŠ”ë° ì»¨í…Œì´ë„ˆê°€ ë°”ë¡œ ì¢…ë£Œë˜ëŠ”â€ ë¬¸ì œë¥¼ ë°©ì§€í•˜ê³ , ì •ìƒì ìœ¼ë¡œ ì…¸ì´ ê³„ì† ì—´ë ¤ ìˆê²Œ ë©ë‹ˆë‹¤.


ì˜ˆì‹œë¡œ ë³´ë©´:

  bash -c "echo hi; bash"        # ìì‹ bashê°€ ëœ¨ê³ , ì›ë˜ í”„ë¡œì„¸ìŠ¤ëŠ” ë‚¨ì•„ìˆìŒ
  bash -c "echo hi; exec bash"   # ì›ë˜ í”„ë¡œì„¸ìŠ¤ê°€ bashë¡œ ëŒ€ì²´ë¨ (ê¹¨ë—í•¨)






------------------------------
3ï¸âƒ£ entrypointì™€ commandì˜ ê´€ê³„
------------------------------

DockerëŠ” ENTRYPOINT + CMD ë‘ ê°€ì§€ ê°œë…ì´ ìˆìŠµë‹ˆë‹¤.
Composeì—ì„œë„ ê·¸ëŒ€ë¡œ ì ìš©ë¼ìš”.

í•­ëª©				ì—­í• 
ENTRYPOINT			ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë  ë•Œ í•­ìƒ ì‹¤í–‰ë˜ëŠ” â€œê¸°ë³¸ ì‹¤í–‰ íŒŒì¼â€
CMD	ENTRYPOINTì— 	ì „ë‹¬ë˜ëŠ” ê¸°ë³¸ ì¸ì ë˜ëŠ”, entrypointê°€ ì—†ì„ ê²½ìš° ì „ì²´ ì»¤ë§¨ë“œ ì—­í• 

ì¦‰,
  entrypoint: ["/bin/bash","-lc"]
  command: ["apt-get update && exec bash"]


ì´ë©´ ìµœì¢…ì ìœ¼ë¡œëŠ” /bin/bash -lc "apt-get update && exec bash" ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.


âœ… Overriding ê·œì¹™ ìš”ì•½
ì¼€ì´ìŠ¤										ì–´ë–¤ ê²Œ ìš°ì„ ?
docker run <image> (entrypointë§Œ ì •ì˜ë¨)	entrypoint ì‹¤í–‰ë¨
docker run --entrypoint						entrypoint ë®ì–´ì”€
docker run <image> <CMD>					CMDê°€ entrypointì— ì¸ìë¡œ ì „ë‹¬ë¨
Composeì˜ command:							CMDì™€ ê°™ì€ ì—­í•  (ë®ì–´ì”€)
Composeì˜ entrypoint:						ENTRYPOINTë¥¼ ì™„ì „íˆ ë®ì–´ì”€


ì˜ˆë¥¼ ë“¤ì–´:

  docker run -it --entrypoint /bin/sh ubuntu

  â†’ ì›ë˜ ENTRYPOINT ê°€ ìˆë”ë¼ë„ ë¬´ì‹œí•˜ê³  /bin/sh ë§Œ ì‹¤í–‰í•¨.



























